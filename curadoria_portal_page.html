<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal do Curador ‚Äì NeuroArte DAO</title>
  <script src="js/web3Auth.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at bottom right, #3b0764 0%, #000000 60%);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    
    .proposal-card {
      transition: all 0.3s ease;
      border-left: 4px solid #d020b1;
    }
    
    .proposal-card:hover {
      transform: translateX(5px);
      box-shadow: 0 0 20px rgba(208, 32, 177, 0.3);
    }
    
    .quorum-bar {
      background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .quorum-fill {
      background: #0ea5e9;
      height: 100%;
      transition: width 0.5s ease;
    }
    
    .vote-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .vote-approved { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .vote-rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .vote-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="text-white min-h-screen pb-20">
  
  <!-- HEADER -->
  <header class="text-center mt-10 mb-8">
    <h1 class="text-4xl font-bold">üñãÔ∏è Portal do Curador</h1>
    <p class="text-gray-300 mt-2">Revise e vote em propostas de arte e pesquisa</p>
    
    <div class="mt-6 flex flex-col gap-4 items-center">
      <button id="connectBtn" onclick="connectCuratorWallet()" class="bg-purple-700 hover:bg-purple-800 px-6 py-2 rounded-xl font-semibold">
        ‚ú® Conectar Wallet
      </button>
      <p id="walletStatus" class="text-sm text-gray-300"></p>
      <p id="curatorBadge" class="text-sm hidden">
        <span class="bg-green-900 bg-opacity-50 px-4 py-1 rounded-full">‚úÖ Curador Verificado</span>
      </p>
    </div>

    <div class="mt-6 flex justify-center gap-4 text-sm">
      <a href="index.html" class="text-purple-400 hover:text-purple-300 underline">üè† In√≠cio</a>
      <a href="artist_portal_page.html" class="text-purple-400 hover:text-purple-300 underline">üé® Artista</a>
      <a href="scientist_portal_page.html" class="text-purple-400 hover:text-purple-300 underline">üî¨ Cientista</a>
      <a href="curator_portal_page.html" class="text-purple-400 hover:text-purple-300 underline font-bold">üñãÔ∏è Curador</a>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-5xl mx-auto px-4">

    <!-- ESTAT√çSTICAS -->
    <section id="statsSection" class="hidden mb-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-900 bg-opacity-70 p-4 rounded-lg border border-purple-700 border-opacity-50">
          <p class="text-gray-400 text-sm">üë• Curadores Ativos</p>
          <p id="totalCurators" class="text-2xl font-bold">-</p>
        </div>
        <div class="bg-gray-900 bg-opacity-70 p-4 rounded-lg border border-purple-700 border-opacity-50">
          <p class="text-gray-400 text-sm">üìä Quorum Necess√°rio (50%+1)</p>
          <p id="quorumNeeded" class="text-2xl font-bold">-</p>
        </div>
        <div class="bg-gray-900 bg-opacity-70 p-4 rounded-lg border border-purple-700 border-opacity-50">
          <p class="text-gray-400 text-sm">‚è≥ Propostas Pendentes</p>
          <p id="totalPending" class="text-2xl font-bold">-</p>
        </div>
        <div class="bg-gray-900 bg-opacity-70 p-4 rounded-lg border border-purple-700 border-opacity-50">
          <p class="text-gray-400 text-sm">‚úÖ Suas Vota√ß√µes</p>
          <p id="yourVotes" class="text-2xl font-bold">0</p>
        </div>
      </div>
    </section>

    <!-- PROPOSTAS PENDENTES -->
    <section id="proposalsSection" class="hidden">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        üìã Propostas em Curadoria
      </h2>

      <div id="proposalsList" class="space-y-6">
        <!-- Propostas carregadas aqui -->
      </div>

      <div id="noProposals" class="text-center py-12 bg-gray-900 bg-opacity-50 rounded-lg border border-gray-700">
        <p class="text-gray-400">‚ú® Nenhuma proposta pendente de curadoria</p>
      </div>
    </section>

    <!-- HIST√ìRICO DE VOTA√á√ïES -->
    <section id="historySection" class="hidden mt-12">
      <h2 class="text-2xl font-bold mb-6">üìú Seu Hist√≥rico de Vota√ß√µes</h2>
      <div id="voteHistory" class="space-y-4">
        <p class="text-gray-400">Suas vota√ß√µes aparecer√£o aqui</p>
      </div>
    </section>

    <!-- MENSAGENS DE STATUS -->
    <div id="statusMessage" class="hidden fixed top-4 right-4 max-w-sm p-4 rounded-lg border-l-4 animate-pulse">
    </div>

  </main>

  <!-- SCRIPT -->
  <script>
    const BACKEND_URL = "https://neuroarte-dao.onrender.com";
    let currentCuratorWallet = null;
    let userVoteCount = 0;
    const voteHistory = {};

    // ============ CONEX√ÉO COM WALLET ============
    async function connectCuratorWallet() {
      try {
        if (!window.ethereum) {
          showStatus('‚ö†Ô∏è Instale MetaMask para continuar', 'warning');
          return null;
        }

        console.log('üîå Conectando √† carteira...');
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });
        const wallet = accounts[0];
        console.log('‚úÖ Carteira conectada:', wallet);

        // Gerar desafio
        console.log('üîê Solicitando desafio...');
        const challengeResponse = await fetch(`${BACKEND_URL}/api/auth/challenge`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet })
        });

        const { message, timestamp } = await challengeResponse.json();
        console.log('üìù Desafio recebido');

        // Assinar mensagem
        console.log('‚úçÔ∏è Pedindo assinatura...');
        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [message, wallet]
        });
        console.log('‚úÖ Mensagem assinada');

        // Verificar assinatura no backend
        console.log('üîç Verificando assinatura no backend...');
        const verifyResponse = await fetch(`${BACKEND_URL}/api/auth/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet,
            message,
            signature
          })
        });

        const verifyData = await verifyResponse.json();

        if (verifyData.success) {
          console.log('üéâ Autentica√ß√£o bem-sucedida!');
          
          localStorage.setItem('authToken', verifyData.token);
          localStorage.setItem('userWallet', wallet);
          currentCuratorWallet = wallet;

          // Verificar se √© curador
          await verifyCuratorStatus();
          
          return {
            token: verifyData.token,
            wallet: wallet
          };
        } else {
          showStatus('‚ùå Falha na autentica√ß√£o: ' + verifyData.error, 'error');
          return null;
        }

      } catch (error) {
        console.error('‚ùå Erro:', error);
        showStatus('‚ùå Erro ao autenticar', 'error');
        return null;
      }
    }

    // ============ VERIFICAR STATUS DE CURADOR ============
    async function verifyCuratorStatus() {
      try {
        const token = localStorage.getItem('authToken');
        const wallet = localStorage.getItem('userWallet');

        const response = await fetch(`${BACKEND_URL}/api/curators/whoami`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.isCurator) {
          console.log('‚úÖ Usu√°rio √© curador!');
          document.getElementById('connectBtn').style.display = 'none';
          document.getElementById('walletStatus').textContent = `‚úÖ Conectado: ${wallet}`;
          document.getElementById('curatorBadge').classList.remove('hidden');
          
          // Mostrar se√ß√µes
          document.getElementById('statsSection').classList.remove('hidden');
          document.getElementById('proposalsSection').classList.remove('hidden');
          document.getElementById('historySection').classList.remove('hidden');

          // Carregar propostas
          await loadPendingProposals();
        } else {
          console.log('‚ùå Usu√°rio n√£o √© curador');
          showStatus('‚ùå Acesso negado: voc√™ n√£o √© um curador autorizado', 'error');
          document.getElementById('walletStatus').textContent = `‚ùå N√£o autorizado`;
        }
      } catch (error) {
        console.error('‚ùå Erro ao verificar status de curador:', error);
        showStatus('‚ùå Erro ao verificar permiss√µes', 'error');
      }
    }

    // ============ CARREGAR PROPOSTAS PENDENTES ============
    async function loadPendingProposals() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/curate/pending`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success && data.pendingProposals.length > 0) {
          document.getElementById('totalPending').textContent = data.pendingProposals.length;
          document.getElementById('totalCurators').textContent = data.curatorInfo.totalCurators;
          document.getElementById('quorumNeeded').textContent = data.curatorInfo.quorumNeeded;

          renderProposals(data.pendingProposals);
          document.getElementById('noProposals').classList.add('hidden');
        } else {
          document.getElementById('noProposals').classList.remove('hidden');
          document.getElementById('proposalsList').innerHTML = '';
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar propostas:', error);
        showStatus('‚ùå Erro ao carregar propostas', 'error');
      }
    }

    // ============ RENDERIZAR PROPOSTAS ============
    function renderProposals(proposals) {
      const container = document.getElementById('proposalsList');
      container.innerHTML = '';

      proposals.forEach(proposal => {
        const card = document.createElement('div');
        card.className = 'proposal-card bg-gray-900 bg-opacity-70 p-6 rounded-lg border border-purple-700';

        const totalVotes = (proposal.votes?.approve || 0) + (proposal.votes?.reject || 0);
        const percentApprove = totalVotes > 0 ? Math.round((proposal.votes.approve / totalVotes) * 100) : 0;

        const statusBadge = proposal.status === 'approved_by_curators' 
          ? '<span class="vote-badge vote-approved">‚úÖ Aprovada</span>'
          : proposal.status === 'rejected_by_curators'
          ? '<span class="vote-badge vote-rejected">‚ùå Rejeitada</span>'
          : '<span class="vote-badge vote-pending">‚è≥ Votando</span>';

        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-bold">${proposal.title}</h3>
              <p class="text-gray-400 text-sm mt-1">#${proposal.type === 'art' ? 'ART' : 'RSH'}-${proposal.id}</p>
            </div>
            ${statusBadge}
          </div>

          <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
            <div>
              <p class="text-gray-400">Tipo</p>
              <p class="font-semibold">${proposal.type === 'art' ? 'üé® Arte' : 'üî¨ Pesquisa'}</p>
            </div>
            <div>
              <p class="text-gray-400">Submetido em</p>
              <p class="font-semibold text-xs">${new Date(proposal.submittedAt).toLocaleDateString('pt-BR')}</p>
            </div>
          </div>

          ${proposal.description ? `
            <div class="mb-4 p-3 bg-gray-800 rounded border border-gray-700">
              <p class="text-gray-300 text-sm">${proposal.description}</p>
            </div>
          ` : ''}

          ${proposal.abstract ? `
            <div class="mb-4 p-3 bg-gray-800 rounded border border-gray-700">
              <p class="text-gray-300 text-sm">${proposal.abstract}</p>
            </div>
          ` : ''}

          <!-- PROGRESSO DE VOTA√á√ÉO -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-400">Progresso de Curadoria</span>
              <span class="text-sm font-semibold">
                <span class="text-green-400">üëç ${proposal.votes?.approve || 0}</span>
                <span class="text-gray-500 mx-2">|</span>
                <span class="text-red-400">üëé ${proposal.votes?.reject || 0}</span>
              </span>
            </div>
            <div class="quorum-bar">
              <div class="quorum-fill" style="width: ${percentApprove}%"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">${totalVotes} votos de curadoria registrados</p>
          </div>

          <!-- BOT√ïES DE VOTA√á√ÉO -->
          <div class="flex gap-3 mt-6">
            <button onclick="voteProposal(${proposal.id}, '${proposal.type}', 'approve')" 
              class="flex-1 bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed px-4 py-2 rounded-lg font-semibold transition">
              ‚úÖ Aprovar
            </button>
            <button onclick="voteProposal(${proposal.id}, '${proposal.type}', 'reject')" 
              class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed px-4 py-2 rounded-lg font-semibold transition">
              ‚ùå Rejeitar
            </button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // ============ VOTAR EM PROPOSTA ============
    async function voteProposal(proposalId, proposalType, vote) {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          showStatus('‚ùå Token expirado. Reconecte sua wallet', 'error');
          return;
        }

        showStatus('‚è≥ Processando voto...', 'info');

        const response = await fetch(`${BACKEND_URL}/api/voting/curate`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            proposalId: parseInt(proposalId),
            proposalType: proposalType,
            vote: vote
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          userVoteCount++;
          document.getElementById('yourVotes').textContent = userVoteCount;

          // Registrar no hist√≥rico
          voteHistory[`${proposalType}_${proposalId}`] = {
            vote: vote,
            timestamp: new Date().toLocaleString('pt-BR')
          };

          showStatus(`‚úÖ Voto registrado: ${vote === 'approve' ? 'Aprovado' : 'Rejeitado'}`, 'success');
          
          // Recarregar propostas
          setTimeout(() => loadPendingProposals(), 1000);
        } else {
          showStatus(`‚ùå ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('‚ùå Erro ao votar:', error);
        showStatus('‚ùå Erro ao registrar voto', 'error');
      }
    }

    // ============ MENSAGEM DE STATUS ============
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
      
      const colors = {
        'success': 'border-green-500 bg-green-900 bg-opacity-30 text-green-400',
        'error': 'border-red-500 bg-red-900 bg-opacity-30 text-red-400',
        'info': 'border-blue-500 bg-blue-900 bg-opacity-30 text-blue-400',
        'warning': 'border-yellow-500 bg-yellow-900 bg-opacity-30 text-yellow-400'
      };
      
      statusDiv.className = `fixed top-4 right-4 max-w-sm p-4 rounded-lg animate-pulse ${colors[type]}`;
      
      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 4000);
    }

    // ============ INICIALIZA√á√ÉO ============
    window.addEventListener('load', async () => {
      const token = localStorage.getItem('authToken');
      const wallet = localStorage.getItem('userWallet');

      if (token && wallet) {
        currentCuratorWallet = wallet;
        await verifyCuratorStatus();
      }
    });
  </script>
</body>
</html>
