<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal do Apoiador â€“ NeuroArte DAO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/web3Auth.js"></script>
  <style>
    body {
      background: radial-gradient(circle at bottom right, #3b0764 0%, #000000 60%);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(28,13,48,0.95) 35%);
      padding: 12px 0;
      text-align: center;
      z-index: 50;
      opacity: 0;
      transition: opacity 1.25s ease-in-out;
    }
  </style>
</head>

<body class="text-white">
  <header class="text-center mt-10">
    <h1 class="text-4xl font-bold">ğŸ§  Portal do Apoiador</h1>
    <p class="text-gray-300 mt-2">Engaje-se com a governanÃ§a e apoie a ciÃªncia aberta.</p>
  </header>

  <!-- SeÃ§Ã£o: Conectar Wallet -->
  <section class="max-w-3xl mx-auto mt-12 bg-gray-900 bg-opacity-70 p-6 rounded-2xl shadow-lg">
    <button onclick="connectWallet()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl">
      ğŸ”Œ Conectar Carteira
    </button>
    <p id="walletStatus" class="text-sm text-gray-300 mt-1"></p>
    <p class="mt-2 text-sm text-gray-300">Compra de $NEURO em breve.</p>
  </section>

  <!-- SeÃ§Ã£o: VotaÃ§Ã£o de Propostas de Arte -->
  <section class="max-w-4xl mx-auto mt-12 bg-gray-900 bg-opacity-70 p-6 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-semibold mb-4">ğŸ¨ VotaÃ§Ã£o: Propostas de Arte</h2>
    <div id="artVotingList" class="space-y-4">
      <p class="text-gray-400">Carregando propostas...</p>
    </div>
  </section>

  <!-- SeÃ§Ã£o: VotaÃ§Ã£o de Propostas de Pesquisa -->
  <section class="max-w-4xl mx-auto mt-12 bg-gray-900 bg-opacity-70 p-6 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-semibold mb-4">ğŸ”¬ VotaÃ§Ã£o: Propostas de Pesquisa</h2>
    <div id="researchVotingList" class="space-y-4">
      <p class="text-gray-400">Carregando propostas...</p>
    </div>
  </section>

  <!-- SeÃ§Ã£o: Envio de SugestÃµes -->
  <section class="max-w-3xl mx-auto mt-12 bg-gray-900 bg-opacity-70 p-6 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-semibold mb-4">ğŸ’¡ Sugerir Nova Pauta</h2>
    <form id="suggestionForm" class="space-y-4" onsubmit="submitSuggestion(event)">
      <input type="text" id="suggestionTitle" placeholder="TÃ­tulo da Proposta" class="w-full p-2 rounded bg-gray-800 text-white border border-purple-700" required>
      <textarea id="suggestionDesc" placeholder="DescriÃ§Ã£o detalhada" class="w-full p-2 h-24 rounded bg-gray-800 text-white border border-purple-700" required></textarea>
      <button type="submit" class="bg-purple-700 hover:bg-purple-800 px-4 py-2 rounded-xl">Enviar SugestÃ£o</button>
    </form>
    <p id="suggestionStatus" class="text-sm text-gray-400 mt-2"></p>
  </section>

  <!-- SeÃ§Ã£o: TransparÃªncia -->
  <section class="max-w-4xl mx-auto mt-12 mb-20 bg-gray-900 bg-opacity-70 p-6 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-semibold text-center mb-4">ğŸ“Š TransparÃªncia da DAO</h2>
    <ul class="text-sm text-gray-300 list-disc pl-6 space-y-1">
      <li>DistribuiÃ§Ã£o de tokens: <a href="#" class="text-blue-400 underline">ver em Dune</a></li>
      <li>Propostas anteriores e resultados</li>
      <li>Auditorias pÃºblicas: contratos, CIDs e hashes registrados</li>
      <li>Fontes de financiamento e COI declarados</li>
    </ul>
  </section>

  <!-- RodapÃ© -->
  <footer id="daoFooter">
    <a href="index.html"
       style="display:inline-block; background:#d026b1; color:#fff;
              padding:8px 14px; border-radius:8px; text-decoration:none;">
      â† Voltar Ã  PÃ¡gina Inicial
    </a>
    <p id="footerText" class="text-gray-400 text-sm mt-2">
      Feito com ğŸ§  e ğŸ’œ pela comunidade NeuroArte DAO.
    </p>
  </footer>

  <!-- Scripts -->
  <script>
    // URL do backend
    const BACKEND_URL = "https://neuroarte-dao.onrender.com";
    let currentWallet = null;

    // ===== CONECTAR WALLET =====
    async function connectWallet() {
      const auth = await authenticateWithWeb3();
      
      if (auth) {
        currentWallet = auth.wallet;
        document.getElementById("walletStatus").textContent = `âœ… Conectada: ${auth.wallet}`;
        loadArtProposals();
        loadResearchProposals();
      } else {
        document.getElementById("walletStatus").textContent = `âŒ Falha na autenticaÃ§Ã£o`;
      }
    }

    // ===== CARREGAR PROPOSTAS DE ARTE =====
    async function loadArtProposals() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/art/proposals`);
        const data = await response.json();

        const container = document.getElementById("artVotingList");
        container.innerHTML = "";

        if (data.proposals.length === 0) {
          container.innerHTML = '<p class="text-gray-400">Nenhuma proposta de arte pendente.</p>';
          return;
        }

        data.proposals.forEach(proposal => {
          const card = document.createElement("div");
          card.className = "border-l-4 border-purple-600 p-4 bg-gray-800 rounded-lg";
          card.innerHTML = `
            <h3 class="font-bold text-lg">ğŸ¨ ${proposal.title}</h3>
            <p class="text-sm text-gray-400">Artista: ${proposal.artistWallet}</p>
            <p class="text-sm text-gray-300 mt-2">${proposal.description}</p>
            <p class="text-sm text-yellow-400 mt-2">IPFS: <a href="https://ipfs.io/ipfs/${proposal.ipfsHash}" target="_blank" class="underline">${proposal.ipfsHash.slice(0, 20)}...</a></p>
            
            <div class="mt-3 flex gap-2">
              <button onclick="voteArt(${proposal.id}, 'for')" class="bg-green-600 hover:bg-green-700 px-4 py-1 rounded text-sm">ğŸ‘ Apoiar</button>
              <button onclick="voteArt(${proposal.id}, 'against')" class="bg-red-600 hover:bg-red-700 px-4 py-1 rounded text-sm">ğŸ‘ Rejeitar</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Votos: âœ… ${proposal.votes.for} | âŒ ${proposal.votes.against}</p>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        console.error("Erro ao carregar propostas de arte:", error);
        document.getElementById("artVotingList").innerHTML = '<p class="text-red-400">Erro ao carregar propostas.</p>';
      }
    }

    // ===== CARREGAR PROPOSTAS DE PESQUISA =====
    async function loadResearchProposals() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/research/proposals`);
        const data = await response.json();

        const container = document.getElementById("researchVotingList");
        container.innerHTML = "";

        if (data.proposals.length === 0) {
          container.innerHTML = '<p class="text-gray-400">Nenhuma proposta de pesquisa pendente.</p>';
          return;
        }

        data.proposals.forEach(proposal => {
          const card = document.createElement("div");
          card.className = "border-l-4 border-cyan-600 p-4 bg-gray-800 rounded-lg";
          card.innerHTML = `
            <h3 class="font-bold text-lg">ğŸ”¬ ${proposal.title}</h3>
            <p class="text-sm text-gray-400">Cientista: ${proposal.scientistWallet}</p>
            <p class="text-sm text-gray-300 mt-2">${proposal.abstract}</p>
            <p class="text-sm text-yellow-400 mt-2">ğŸ’° Financiamento solicitado: $${proposal.requestedFunding} NEURO</p>
            
            <div class="mt-3 flex gap-2">
              <button onclick="voteResearch(${proposal.id}, 'for')" class="bg-green-600 hover:bg-green-700 px-4 py-1 rounded text-sm">ğŸ‘ Financiar</button>
              <button onclick="voteResearch(${proposal.id}, 'against')" class="bg-red-600 hover:bg-red-700 px-4 py-1 rounded text-sm">ğŸ‘ Rejeitar</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Votos: âœ… ${proposal.votes.for} | âŒ ${proposal.votes.against}</p>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        console.error("Erro ao carregar propostas de pesquisa:", error);
        document.getElementById("researchVotingList").innerHTML = '<p class="text-red-400">Erro ao carregar propostas.</p>';
      }
    }

    // ===== VOTAR EM ARTE =====
    async function voteArt(proposalId, vote) {
      const token = getAuthToken();
      if (!token) {
        alert('âŒ VocÃª precisa estar autenticado para votar');
        return;
      }

      const wallet = getUserWallet();

      try {
        const response = await authenticatedFetch(`${BACKEND_URL}/api/voting/vote`, {
          method: "POST",
          body: JSON.stringify({
            proposalId,
            proposalType: "art",
            voterWallet: wallet,
            vote
          })
        });

        const result = await response.json();

        if (result.success) {
          alert("âœ… Voto registrado!");
          loadArtProposals();
        } else {
          alert(`âŒ ${result.error}`);
        }
      } catch (error) {
        alert("Erro ao votar");
      }
    }

    // ===== VOTAR EM PESQUISA =====
    async function voteResearch(proposalId, vote) {
      const token = getAuthToken();
      if (!token) {
        alert('âŒ VocÃª precisa estar autenticado para votar');
        return;
      }

      const wallet = getUserWallet();

      try {
        const response = await authenticatedFetch(`${BACKEND_URL}/api/voting/vote`, {
          method: "POST",
          body: JSON.stringify({
            proposalId,
            proposalType: "research",
            voterWallet: wallet,
            vote
          })
        });

        const result = await response.json();

        if (result.success) {
          alert("âœ… Voto registrado!");
          loadResearchProposals();
        } else {
          alert(`âŒ ${result.error}`);
        }
      } catch (error) {
        alert("Erro ao votar");
      }
    }

    // ===== ENVIAR SUGESTÃƒO =====
    async function submitSuggestion(event) {
      event.preventDefault();

      const title = document.getElementById("suggestionTitle").value;
      const description = document.getElementById("suggestionDesc").value;
      const statusMsg = document.getElementById("suggestionStatus");

      statusMsg.textContent = "â³ Enviando...";

      // Por enquanto, apenas confirma (depois conecta a um endpoint real)
      setTimeout(() => {
        statusMsg.textContent = "âœ… SugestÃ£o enviada! Obrigado por contribuir.";
        document.getElementById("suggestionForm").reset();
      }, 1000);
    }

    // ===== CARREGAR DADOS INICIAIS =====
    loadArtProposals();
    loadResearchProposals();

    // Atualizar a cada 10 segundos
    setInterval(() => {
      loadArtProposals();
      loadResearchProposals();
    }, 10000);

    // ===== FOOTER DINÃ‚MICO =====
    window.addEventListener('scroll', () => {
      const footer = document.getElementById('daoFooter');
      const scrollY = window.scrollY;
      const windowH = window.innerHeight;
      const docHeight = document.body.scrollHeight;
      if ((scrollY + windowH) >= docHeight - 100) {
        footer.style.opacity = 1;
      } else {
        footer.style.opacity = 0;
      }
    });

    const messages = [
      "Feito com ğŸ§  e ğŸ’œ pela comunidade NeuroArte DAO.",
      "GovernanÃ§a Ã©tica, transparente e descentralizada.",
      "Onde arte e neurodiversidade encontram a pesquisa.",
      "DAO: Ã©tica, arte e ciÃªncia em rede viva."
    ];
    let index = 0;
    setInterval(() => {
      index = (index + 1) % messages.length;
      document.getElementById("footerText").textContent = messages[index];
    }, 6000);
  </script>
</body>
</html>
